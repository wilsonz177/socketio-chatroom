<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      
      <!-- Latest compiled and minified CSS -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
      <!-- jQuery library -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
      <!-- Latest compiled JavaScript -->
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
      
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
      <script src="/socket.io/socket.io.js"></script>

<!--<style>-->
<!--      [class*="col-"] {-->
<!--  padding-top: 15px;-->
<!--  padding-bottom: 15px;-->
<!--  background-color: #eee;-->
<!--  background-color: rgba(86,61,124,.15);-->
<!--  border: 1px solid #ddd;-->
<!--  border: 1px solid rgba(86,61,124,.2);-->
<!--}-->
<!--    </style>-->
 <style>
   .form-group select{
      display: inline-block;
      width: auto;
   }
 </style>
 
      <script>
      $(document).ready(function() {
         var socketio = io.connect();
         $("#message").hide();
         $("#rooms").hide();
         $("#users").hide();
         $("form").submit(function(event){
            event.preventDefault();
         });
         
         $("#submitusername").click(function(){ //just adds the new user
            var name = $("#name").val();
            if (name !== "") {
                socketio.emit("submitusername", name);
                $("#login").detach();
                $("#rooms").show();
            }
         });
         
         $("#join").click(function(){
            var pub = $("#allrooms").val();
            var room = $("#allrooms option:selected").text();
            console.log("pub: ", pub);
            console.log("room: ", room);
            var pass = $("#privatepassword").val();
           
            socketio.emit("join",{"room": room, "pub":pub, "pass": pass});
         });
         
          $("#send").click(function(){
            var msg = $("#messageToChat").val();
            socketio.emit("message_to_server", msg);
            $("#messageToChat").val("");
         });
          
         $("#create").click(function(){
            var roomname = $("chatroomname").val();
            var type = $("typeofroom").val();
            var password = $("chatroompassword").val();
            var a = true;
            if (type == "private"){
               a = false;
            }
            console.log("pressed create");
            socketio.emit("createroom", { "roomname": roomname, "pub": a, "password": password});
         });
          
          
         $("#message").keydown(function(e){
            if(e.which == 13) {
               console.log("enter");
                var msg = $("#messageToChat").val();
                socketio.emit("message_to_server", msg);
                $("#messageToChat").val("");
            }
         });
         
         $("#typeofroom").on('change', function() {
            if ($("#typeofroom").val() == "private") {
                $("#setpassword").show();
            }
            if ($("#typeofroom").val() == "public") {
                $("#setpassword").hide();
            }
            
          });
         
         $("#allrooms").on('change', function() {
            if ($("#allrooms").val() == "false") {
                $("#passwordforprivateroom").show();
            }
            if ($("#allrooms").val() == "true") {
               $("#passwordforprivateroom").hide();
            }
            
          });
         
         socketio.on("banned", function() {

                $("#msgfromroom").append("You're banned from this room!");            
         });
         
         socketio.on("wrongpassword", function() {     
               $("#privatepassword").attr("placeholder", "Wrong Password!");             
         });
         
         socketio.on("loadpage", function(rooms) {
            console.log("loading");
            for (var key in rooms){
               console.log(key);
               if (key.pub === true){
                  $("#allrooms").append($('<option>', { 
                        value: "true",
                        text : key
                    }));
               } else {
                   $("#allrooms").append($('<option>', { 
                        value: "false",
                        text : key
                    }));
               }
            }
         });

         socketio.on("update", function(people){
            console.log("about to hide room options");
                $("#allrooms").hide();
                $("#message").show();
                $("#people").empty();
                $.each(people, function(socketid, name) {
                    $('#people').append("" + name + "");
                });
         });
         
         socketio.on("message_to_client", function(who, msg){
                //$("#msgs").append("" + who + " says: " + msg + "");
             console.log("who: ", who);
             console.log("msg: ", msg);
            var tr = $("<tr/>");
            tr.append(
               $("<td/>")
                  .text(who + ": ")
            );
            tr.append(
               $("<td/>")
                  .text(msg)
            );
               
               
                
            $("#msgs").append(tr);
                                 
         });
         
         //socketio.on("disconnect", function(){
         //   $("#msgs").append("The server is not available");
         //   $("#message").attr("disabled", "disabled");
         //   $("#send").attr("disabled", "disabled");
         //});
             
      });
      
      </script>
      
      
   
   </head>
   <body>
      <div class="container-fluid">
       
      <div>
         <h3>Welcome to our Chatroom Portal</h3>
      </div>  
            
      <div id="login" class="form-group" >
         <form>
            <label for="name">Username</label>
                      <input type="text" class="form-control" id="name"><br>
                      <input type="button" name="submitusername" class="btn btn-primary" id="submitusername" value="Submit">
         </form>
      </div>
      
      
      <div id="rooms">
         <div class="form-group">
            <label for="allrooms">Chatrooms</label>
            <select id="allrooms" class="form-control">
   
            </select>
            <div id="passwordforprivateroom" class="form-inline">
                  <label for="privatepassword">Password</label>
                  <input type="text"  class="form-control" id="privatepassword" placeholder="">
            </div>
         </div>
         
         <span id="msgfromroom">  
         
         <input type="button" name="join" id="join" value="Join" class="btn btn-primary">
         
         <div>
            <form id = "newchatroom" class="form-inline">
            <div class="form-group">
               <h4>Create a new chat room</h4>
               <label for="chatroomname">Name of Room</label>
               <input type="text" class="form-control" id="chatroomname">
               <select id="typeofroom" class="form-control">
                  <option value="private" selected="selected">Private</option>
                  <option value="public" >Public</option>
               </select>
               <div id="setpassword">
                  <label for="chatroompassword">Password</label>
                  <input type="text"class="form-control"  id="chatroompassword">
               </div>
                     <input type="submit" name="create" id="create" value="Create" class="btn btn-primary">
            
            </div>
            </form>
         </div>
         
      </div>
         
            
      <div id="users">
         People: 
         <ul id="people"></ul>
      </div>
      
     
      <div id="chatlog">
         
         <h4>Chatroom Name: <span id="nameOfCurrentChatRoom">CSE330</span></h4>

         <table class="table table-striped" id="msgs">
            
               <th class="col-md-1">Username</th>
               <th class = "col-md-11">Message</th>
               
            </tr >
           
            
         </table>

      </div>
      
      
       <div id="message">
         <form class="form-group">
            <label for="messageToChat">Enter your message:</label>
            <input type="text" id="messageToChat" class="form-control" >
            <input type="button" name="send" id="send" value="Send" class="btn btn-default">
         </form>
      </div>
      
      
      </div>
   </body>
</html>